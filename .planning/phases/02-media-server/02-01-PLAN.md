---
phase: 02-media-server
type: execute
domain: media-streaming
---

<objective>
Configure self-hosted media server (MediaMTX) for RTMP ingest and HLS output.

Purpose: Establish the core infrastructure that allows users to broadcast live video and others to watch it.
Output: A running MediaMTX instance in Docker, configured to accept RTMP and serve HLS.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-media-server/DISCOVERY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Media Server Docker Setup</name>
  <files>media/docker-compose.yml</files>
  <action>Create a `media` directory and a `docker-compose.yml` file. Use `bluenviron/mediamtx:latest`. Map ports 1935 (RTMP), 8888 (HLS/API), and 8554 (RTSP - optional but good default). configuration file `mediamtx.yml` should be mounted from host.</action>
  <verify>`docker compose -f media/docker-compose.yml config` validates the file.</verify>
  <done>Valid docker-compose file exists.</done>
</task>

<task type="auto">
  <name>Task 2: MediaMTX Configuration</name>
  <files>media/mediamtx.yml</files>
  <action>Create `media/mediamtx.yml`. Enable RTMP and HLS. Set `hlsVariant: lowLatency` (optional, start with standard if easier, but DISCOVERY mentioned LL-HLS). Ensure paths are configured so `rtmp://localhost:1935/live/stream` produces HLS at `http://localhost:8888/live/stream/index.m3u8`.</action>
  <verify>Launch container: `docker compose -f media/docker-compose.yml up -d`. Check logs: `docker compose -f media/docker-compose.yml logs`.</verify>
  <done>Server starts without errors and listens on ports.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Media Server Infrastructure</what-built>
  <how-to-verify>
    1. Start server: `cd media && docker compose up -d`
    2. Stream (Simulate Streamer): `ffmpeg -re -f lavfi -i testsrc=size=640x480:rate=30 -vcodec libx264 -preset veryfast -tune zerolatency -c:a aac -f flv rtmp://localhost:1935/live/test`
    3. Watch (Simulate Viewer): Open `http://localhost:8888/live/test/index.m3u8` in a player (VLC or Safari).
    4. Confirm: Video plays.
  </how-to-verify>
  <resume-signal>Type "approved" if stream plays successfully.</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Docker container is running healthy.
- [ ] RTMP port 1935 is open.
- [ ] HLS port 8888 is open.
- [ ] FFmpeg can push stream.
- [ ] Stream plays in VLC/Browser.
</verification>

<success_criteria>
- MediaMTX running in Docker.
- RTMP ingest works.
- HLS playback works.
- Configuration committed.
</success_criteria>

<output>
After completion, create `.planning/phases/02-media-server/02-01-SUMMARY.md`
</output>
