---
phase: 03-backend-api
plan: 01
type: execute
---

<objective>
Set up asynchronous database infrastructure AND testing foundation.

Purpose: Provide persistence layer and enable TDD for subsequent tasks.
Output: Configured DB, Models, Migrations, and `conftest.py` with DB fixtures.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Tech Decisions**:
- **SQLAlchemy (Async) + SQLite**: Produciton DB.
- **pytest + httpx + aiosqlite**: Testing stack.
- **In-Memory DB**: For fast, isolated tests.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Database Dependencies</name>
  <files>backend/pyproject.toml</files>
  <action>
    1. Add dependencies to `backend/pyproject.toml`:
       - `sqlalchemy[asyncio]`
       - `aiosqlite`
       - `alembic`
    2. Run `uv sync` to install.
  </action>
  <verify>
    cd backend && uv run python -c "import sqlalchemy; import alembic; print('DB deps installed')"
  </verify>
  <done>Dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Configure Database Connection</name>
  <files>backend/src/app/db.py, backend/src/app/config.py</files>
  <action>
    1. Update `backend/src/app/config.py` with `database_url`.
    2. Create `backend/src/app/db.py` with `AsyncEngine`, `AsyncSession`, and `get_db` dependency.
  </action>
  <verify>
    cd backend && uv run python -c "from app.db import Base, engine; print('DB config OK')"
  </verify>
  <done>Database engine configured</done>
</task>

<task type="auto">
  <name>Task 3: Define Data Models</name>
  <files>backend/src/app/models/device.py, backend/src/app/models/stream.py</files>
  <action>
    1. Create `backend/src/app/models/device.py` (device_id PK).
    2. Create `backend/src/app/models/stream.py` (id UUID, stream_code, rtmp_url, hls_url, status).
  </action>
  <verify>
    cd backend && uv run python -c "from app.models import Device, Stream; print('Models OK')"
  </verify>
  <done>Models defined</done>
</task>

<task type="auto">
  <name>Task 4: Setup Alembic Migrations</name>
  <files>backend/alembic.ini, backend/src/app/migrations/</files>
  <action>
    1. Initialize alembic async.
    2. Configure `env.py` to use `app.models.Base` and config settings.
    3. Generate and apply initial migration.
  </action>
  <verify>
    test -f backend/streamlive.db
  </verify>
  <done>Migrations appled</done>
</task>

<task type="auto">
  <name>Task 5: Setup Test Infrastructure</name>
  <files>backend/src/app/tests/conftest.py</files>
  <action>
    1. Create `backend/src/app/tests/` directory.
    2. Create `backend/src/app/tests/conftest.py`.
    3. Implement `db_session` fixture:
       - Use `sqlite+aiosqlite:///:memory:`.
       - Run `Base.metadata.create_all` before yielding.
    4. Implement `async_client` fixture:
       - Using `httpx.AsyncClient` and overriding `get_db`.
  </action>
  <verify>
    cd backend && uv run pytest --collect-only
  </verify>
  <done>Test fixtures ready for TDD</done>
</task>

</tasks>

<verification>
- [ ] Database file exists.
- [ ] `uv run pytest` collects fixtures without error.
</verification>

<output>
Next: Ready for 03-02-PLAN.md (Stream Implementation via TDD)
</output>
