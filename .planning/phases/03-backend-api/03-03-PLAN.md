---
phase: 03-backend-api
plan: 03
type: execute
---

<objective>
Implement Device Authentication using TDD.

Purpose: Secure endpoints and enforce stream ownership.
Output: Secured API with verified permission logic.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-phase.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-backend-api/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD - Auth Tests</name>
  <files>backend/src/app/tests/test_auth.py</files>
  <action>
    Create `backend/src/app/tests/test_auth.py` and write failing tests:
    1. `test_create_stream_no_header` -> Expect 403/422.
    2. `test_create_stream_auto_creates_device` -> Expect new Device in DB.
    3. `test_stop_stream_wrong_device` -> Expect 403 (Cross-device protection).
  </action>
  <verify>
    cd backend && uv run pytest src/app/tests/test_auth.py
    (Should fail or error)
  </verify>
  <done>Tests Defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement Auth & Permissions</name>
  <files>backend/src/app/api/deps.py, backend/src/app/api/v1/streams.py</files>
  <action>
    1. Implement `get_current_device` dependency in `deps.py`.
    2. Update `streams.py` routers to use dependency.
    3. Add ownership check in `stop_stream` logic/endpoint.
    4. Run tests until green.
  </action>
  <verify>
    cd backend && uv run pytest src/app/tests/test_auth.py
  </verify>
  <done>All security tests passed</done>
</task>

</tasks>

<verification>
- [ ] `uv run pytest` passes all tests (including regressions from 02).
</verification>

<output>
Next: Phase 3 Complete.
</output>
